<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Профиль Пользователя</title>
  <style>
    :root {
      --neon-blue: #00e5ff;
      --neon-dark: #0a0a0a;
      --neon-bg: #111;
      --neon-text: #e0e0e0;
      --neon-shadow: 0 0 8px var(--neon-blue), 0 0 12px rgba(0, 229, 255, 0.5);
    }

    body {
      margin: 0;
      padding: 20px;
      background: var(--neon-dark);
      color: var(--neon-text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      touch-action: pan-y;

      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }
    #video-background {
        position: fixed;
        right: 0;
        bottom: 0;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        z-index: -1;
        object-fit: cover;
        filter: brightness(0.4);
    }
    h1, h2 {
      text-align: center;
      color: var(--neon-blue);
      text-shadow: var(--neon-shadow);
    }
    .profile-section-container {
      width: 100%;
      max-width: 650px;
      margin: 0 auto;
      overflow: hidden;
      position: relative;
      cursor: grab;
    }
    .profile-section-container.grabbing { cursor: grabbing; }
    .profile-wrapper {
      display: flex;
      transition: transform 0.3s ease-in-out;
    }
    .profile-card {
      min-width: 100%;
      box-sizing: border-box;
      padding: 20px;
      background: var(--neon-bg);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 229, 255, 0.4);
      border: 1px solid rgba(0, 229, 255, 0.3);
    }
    .profile-controls {
      display: flex; flex-wrap: wrap; justify-content: center;
      align-items: center; gap: 10px; margin-bottom: 20px;
    }
    #profileSelector {
      flex-grow: 1; background: var(--neon-bg); border: 1px solid var(--neon-blue);
      border-radius: 8px; padding: 10px 15px; color: var(--neon-text);
      font-size: 16px; cursor: pointer; appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300e5ff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
      background-repeat: no-repeat; background-position: right 15px center; background-size: 12px auto;
    }
    .profile-controls button {
      padding: 10px 15px; background: var(--neon-bg);
      border: 1px solid #ffab00; color: #ffab00;
      border-radius: 8px; cursor: pointer; font-size: 14px;
      font-weight: bold; transition: transform .2s, box-shadow .2s;
      white-space: nowrap;
    }
    .profile-controls button:hover { transform: scale(1.05); }
    .profile-controls button#addProfileBtn { border-color: #56ff56; color: #56ff56; }
    .profile-controls button#deleteProfileBtn { border-color: #ff4d4d; color: #ff4d4d; }
    .skills-container { margin-top: 15px; display: flex; flex-direction: column; gap: 12px; }
    .skill-bar-container { display: flex; flex-direction: column; gap: 5px; cursor: pointer; padding: 5px; border-radius: 5px; transition: background-color 0.2s; }
    .skill-bar-container:hover { background-color: rgba(255,255,255,0.05); }
    .skill-bar-label { display: flex; justify-content: space-between; font-weight: bold; font-size: 15px; }
    .skill-bar-name { color: var(--neon-blue); }
    .skill-bar-value { color: var(--neon-text); }
    .skill-bar-bg { width: 100%; background: rgba(0,0,0,0.3); border-radius: 5px; height: 12px; overflow: hidden; border: 1px solid rgba(0, 229, 255, 0.2); }
    .skill-bar-fill {
      height: 100%; background: linear-gradient(90deg, #007bff, var(--neon-blue));
      border-radius: 4px; transition: width 0.5s ease-out; box-shadow: 0 0 8px var(--neon-blue);
    }
    .profile-indicator { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
    .profile-indicator-dot { width: 8px; height: 8px; border-radius: 50%; background-color: rgba(0, 229, 255, 0.4); transition: all 0.3s ease; }
    .profile-indicator-dot.active { background-color: var(--neon-blue); transform: scale(1.2); }
    .main-actions { display: flex; justify-content: center; gap: 15px; margin-top: 30px; }
    .main-actions a, .main-actions button {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 10px 20px; background: var(--neon-bg); border: 1px solid var(--neon-blue); color: var(--neon-blue);
      border-radius: 8px; cursor: pointer; text-decoration: none;
      box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
      transition: transform .2s, box-shadow .2s;
    }
    .main-actions a:hover, .main-actions button:hover { transform: translateY(-3px); box-shadow: 0 0 15px rgba(0, 229, 255, 0.6); }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; backdrop-filter: blur(5px); }
    .modal-content { position: relative; background: var(--neon-bg); padding: 25px; border-radius: 10px; width: 95%; max-width: 400px; box-shadow: 0 0 25px rgba(0,229,255,0.5); border: 1px solid rgba(0, 229, 255, 0.5); }
    .modal-content h3 { margin-top: 0; margin-bottom: 20px; text-align: center; color: var(--neon-blue); }
    .modal-content label, .modal-content p { display: block; margin: 12px 0 5px; color: var(--neon-blue); font-weight: bold; font-size: 14px; }
    .modal-content input[type="text"], .modal-content input[type="range"] { width: 100%; box-sizing: border-box; margin-bottom: 10px; background: var(--neon-dark); border: 1px solid var(--neon-blue); border-radius: 5px; padding: 8px 12px; color: var(--neon-text); font-size: 15px; }
    .modal-content input[type="range"] { padding: 0; }
    .modal-content output { display: block; text-align: center; font-size: 16px; font-weight: bold; color: var(--neon-blue); }
    .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
    .modal-buttons button { flex: 1; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; transition: all 0.2s ease; }
    .modal-confirm-btn { background-color: var(--neon-blue); color: var(--neon-bg); }
    .modal-cancel-btn { background-color: #555; color: #fff; }
    .modal-delete-btn { background-color: #ff4d4d; color: #fff; }
    .modal-close { position: absolute; top: 10px; right: 15px; background: none; border: none; cursor: pointer; font-size: 24px; color: #aaa; transition: color 0.2s, transform 0.2s; }
    .modal-close:hover { color: #fff; transform: rotate(90deg); }
    .hidden { display: none !important; }
  </style>
</head>
<script src="sounds.js" defer></script>
<body>

  <video autoplay loop muted playsinline id="video-background" style="display: none;">
      <source src="background.mp4" type="video/mp4">
  </video>

  <h1>Профиль Пользователя</h1>

  <div class="profile-controls">
      <select id="profileSelector"></select>
      <button id="renameProfileBtn" title="Переименовать текущий профиль" class="clickable-sound">Переименовать</button>
      <button id="addProfileBtn" title="Добавить новый профиль" class="clickable-sound">Добавить</button>
      <button id="deleteProfileBtn" title="Удалить текущий профиль" class="clickable-sound">Удалить</button>
  </div>

  <div id="profile-section-container" class="profile-section-container">
      <div id="profile-wrapper" class="profile-wrapper"></div>
  </div>

  <div id="profileIndicator" class="profile-indicator"></div>

  <div class="main-actions">
      <a href="index.html" class="clickable-sound">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px;">
            <path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L8.354 1.146zM12 14H9.5v-4.5a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5V14H4V7.707l4-4 4 4V14z"/>
        </svg>
        На главную
      </a>
      <button id="manageSkillsBtn" class="clickable-sound">Управление навыками</button>
  </div>

  <!-- Модальное окно для редактирования/добавления НАВЫКА -->
  <div class="modal-overlay" id="skillModal">
    <div class="modal-content">
      <button class="modal-close clickable-sound" id="skillModalClose">×</button>
      <h3 id="skillModalTitle">Редактировать навык</h3>
      <label for="skillModalName">Название навыка</label>
      <input type="text" id="skillModalName" placeholder="Введите название">
      <label for="skillModalValue">Значение (0-100)</label>
      <input type="range" id="skillModalValue" min="0" max="100">
      <output id="skillModalOutput"></output>
      <div class="modal-buttons">
        <button id="skillModalDelete" class="modal-delete-btn clickable-sound">Удалить</button>
        <button id="skillModalCancel" class="modal-cancel-btn clickable-sound">Отмена</button>
        <button id="skillModalSave" class="modal-confirm-btn clickable-sound">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Общее модальное окно для действий с ПРОФИЛЕМ -->
  <div class="modal-overlay" id="actionModal">
    <div class="modal-content">
        <button class="modal-close clickable-sound" id="actionModalClose">×</button>
        <h3 id="actionModalTitle">Действие</h3>
        <p id="actionModalText" class="hidden"></p>
        <input type="text" id="actionModalInput" class="hidden" placeholder="Введите имя">
        <div class="modal-buttons">
            <button id="actionModalCancel" class="modal-cancel-btn clickable-sound">Отмена</button>
            <button id="actionModalConfirm" class="modal-confirm-btn clickable-sound">Подтвердить</button>
        </div>
    </div>
  </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // Apply video setting
    const videoBackground = document.getElementById('video-background');
    if (videoBackground) {
        const SETTINGS_KEY = 'app_settings';
        const savedSettings = localStorage.getItem(SETTINGS_KEY);
        let showVideo = true; // Default to true
        if (savedSettings) {
            try {
                const settings = JSON.parse(savedSettings);
                if (settings.showVideoBackground === false) {
                    showVideo = false;
                }
            } catch (e) { console.error("Could not parse settings, using default for video.", e); }
        }
        videoBackground.style.display = showVideo ? 'block' : 'none';
    }

    // Original script content starts here
});

document.addEventListener('DOMContentLoaded', () => {
    // --- Глобальные переменные и константы ---
    const PROFILES_STORAGE_KEY = 'userProfilesData_v1';
    const INDEX_STORAGE_KEY = 'levelUpData_v1_1'; // Ключ из index.html
    const IMPORTED_PROFILE_KEY = 'imported_skills';
    
    let allProfilesData = {};
    let currentProfileKey = null;
    let editedSkillIndex = -1;

    // --- Переменные для свайпа и перетаскивания ---
    const profileContainer = document.getElementById('profile-section-container');
    const profileWrapper = document.getElementById('profile-wrapper');
    let touchStartX = 0;
    let currentTranslate = 0;
    let startTranslate = 0;
    let isDragging = false;

    // --- DOM Элементы ---
    const profileSelector = document.getElementById('profileSelector');
    const profileIndicator = document.getElementById('profileIndicator');
    const renameProfileBtn = document.getElementById('renameProfileBtn');
    const addProfileBtn = document.getElementById('addProfileBtn');
    const deleteProfileBtn = document.getElementById('deleteProfileBtn');
    const manageSkillsBtn = document.getElementById('manageSkillsBtn');

    // Модальное окно для навыков
    const skillModal = document.getElementById('skillModal');
    const skillModalTitle = document.getElementById('skillModalTitle');
    const skillModalName = document.getElementById('skillModalName');
    const skillModalValue = document.getElementById('skillModalValue');
    const skillModalOutput = document.getElementById('skillModalOutput');
    const skillModalSave = document.getElementById('skillModalSave');
    const skillModalCancel = document.getElementById('skillModalCancel');
    const skillModalDelete = document.getElementById('skillModalDelete');
    const skillModalClose = document.getElementById('skillModalClose');

    // Модальное окно для действий
    const actionModal = document.getElementById('actionModal');
    const actionModalTitle = document.getElementById('actionModalTitle');
    const actionModalText = document.getElementById('actionModalText');
    const actionModalInput = document.getElementById('actionModalInput');
    const actionModalConfirm = document.getElementById('actionModalConfirm');
    const actionModalCancel = document.getElementById('actionModalCancel');
    const actionModalClose = document.getElementById('actionModalClose');

    // --- Функции для работы с данными ---
    function saveData() {
        try {
            localStorage.setItem(PROFILES_STORAGE_KEY, JSON.stringify(allProfilesData));
        } catch (e) {
            console.error("Ошибка сохранения данных:", e);
        }
    }

    function loadData() {
        // Загружаем данные этого файла
        const profilesDataRaw = localStorage.getItem(PROFILES_STORAGE_KEY);
        allProfilesData = profilesDataRaw ? JSON.parse(profilesDataRaw) : {};
        
        // Интегрируем данные из index.html
        importIndexSkills();

        // Если данных всё ещё нет, создаем по умолчанию
        if (Object.keys(allProfilesData).length === 0) {
            allProfilesData = {
                'profile_1': { name: "Воин", skills: [{ name: 'Сила', value: 85 }, { name: 'Ловкость', value: 70 }] },
                'profile_2': { name: "Маг", skills: [{ name: 'Интеллект', value: 95 }, { name: 'Мана', value: 100 }] }
            };
        }
        
        const keys = Object.keys(allProfilesData);
        currentProfileKey = keys.includes(IMPORTED_PROFILE_KEY) ? IMPORTED_PROFILE_KEY : keys[0];
    }

    function importIndexSkills() {
        const indexDataRaw = localStorage.getItem(INDEX_STORAGE_KEY);
        if (!indexDataRaw) return;

        try {
            const indexData = JSON.parse(indexDataRaw);
            if (indexData && Array.isArray(indexData.skills)) {
                const filteredSkills = indexData.skills
                    .filter(skill => skill.level >= 1 && skill.level <= 50)
                    .map(skill => ({
                        name: skill.name,
                        value: Math.min(skill.level * 2, 100) // Масштабируем уровень в проценты
                    }));
                
                if (filteredSkills.length > 0) {
                     allProfilesData[IMPORTED_PROFILE_KEY] = {
                        name: "Навыки (1-50 ур.)",
                        skills: filteredSkills
                    };
                } else {
                    // Если после фильтрации навыков не осталось, удаляем профиль
                    delete allProfilesData[IMPORTED_PROFILE_KEY];
                }
            }
        } catch (e) {
            console.error("Ошибка импорта данных из index.html:", e);
        }
    }

    // --- Функции рендеринга и обновления UI ---
    function populateProfileSelector() {
        const keys = Object.keys(allProfilesData);
        profileSelector.innerHTML = '';
        const hasProfiles = keys.length > 0;
        const controls = [renameProfileBtn, deleteProfileBtn, manageSkillsBtn, profileSelector];
        controls.forEach(c => c.disabled = !hasProfiles);
        if (!hasProfiles) return;

        keys.forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = allProfilesData[key].name;
            if (key === IMPORTED_PROFILE_KEY) {
                option.style.fontWeight = 'bold';
                option.style.color = '#7afcff';
            }
            profileSelector.appendChild(option);
        });
        profileSelector.value = currentProfileKey;
    }

    function renderAllProfiles() {
        profileWrapper.innerHTML = '';
        const profileKeys = Object.keys(allProfilesData);

        if (profileKeys.length === 0) {
            profileWrapper.innerHTML = `<div class="profile-card" style="min-width: 100%;"><p>Профили отсутствуют. Нажмите "Добавить", чтобы создать новый.</p></div>`;
            updateProfileIndicator();
            return;
        }

        profileKeys.forEach(key => {
            const profileData = allProfilesData[key];
            const profileCard = document.createElement('div');
            profileCard.className = 'profile-card';
            profileCard.dataset.key = key;

            let skillsHTML = profileData.skills.map((skill, index) => `
                <div class="skill-bar-container" data-skill-index="${index}" title="Нажмите для редактирования">
                    <div class="skill-bar-label">
                        <span class="skill-bar-name">${skill.name}</span>
                        <span class="skill-bar-value">${skill.value}%</span>
                    </div>
                    <div class="skill-bar-bg">
                        <div class="skill-bar-fill" style="width: ${skill.value}%;"></div>
                    </div>
                </div>
            `).join('');

            profileCard.innerHTML = `<h2>${profileData.name}</h2><div class="skills-container">${skillsHTML || '<p>Нет навыков.</p>'}</div>`;
            profileWrapper.appendChild(profileCard);

            // Добавляем обработчики кликов на шкалы для редактирования
            profileCard.querySelectorAll('.skill-bar-container').forEach(el => {
                el.addEventListener('click', (e) => {
                    const profileKey = el.closest('.profile-card').dataset.key;
                    if (profileKey === IMPORTED_PROFILE_KEY) {
                        alert("Этот профиль импортирован и не может быть изменен здесь. Управляйте навыками на главной странице.");
                        return;
                    }
                    if (profileKey === currentProfileKey) {
                        openSkillModal(+el.dataset.skillIndex);
                    }
                });
            });
        });

        updateProfileIndicator();
        switchToProfile(currentProfileKey, 'none');
    }

    function updateProfileIndicator() {
        profileIndicator.innerHTML = '';
        const keys = Object.keys(allProfilesData);
        if (keys.length <= 1) return;
        const currentIndex = keys.indexOf(currentProfileKey);
        keys.forEach((_, i) => {
            const dot = document.createElement('div');
            dot.className = 'profile-indicator-dot';
            if (i === currentIndex) dot.classList.add('active');
            profileIndicator.appendChild(dot);
        });
    }

    function switchToProfile(key, transition = 'auto') {
        const keys = Object.keys(allProfilesData);
        const index = keys.indexOf(key);
        if (index === -1) return;

        currentProfileKey = key;
        if (profileSelector.value !== key) profileSelector.value = key;
        
        // Запрещаем редактирование для импортированного профиля
        const isImported = key === IMPORTED_PROFILE_KEY;
        renameProfileBtn.disabled = isImported;
        deleteProfileBtn.disabled = isImported;
        manageSkillsBtn.disabled = isImported;
        
        currentTranslate = -index * profileContainer.offsetWidth;
        profileWrapper.style.transition = transition === 'none' ? 'none' : 'transform 0.3s ease-in-out';
        profileWrapper.style.transform = `translateX(${currentTranslate}px)`;
        updateProfileIndicator();
    }

    // --- Функции Модальных Окон ---
    function openSkillModal(skillIndex) {
        editedSkillIndex = skillIndex;
        const isAdding = skillIndex === -1;
        skillModalTitle.textContent = isAdding ? "Добавить навык" : "Редактировать навык";
        skillModalDelete.style.display = isAdding ? 'none' : 'block';
        skillModalName.value = isAdding ? "" : allProfilesData[currentProfileKey].skills[skillIndex].name;
        skillModalValue.value = isAdding ? 50 : allProfilesData[currentProfileKey].skills[skillIndex].value;
        skillModalOutput.textContent = skillModalValue.value;
        skillModal.style.display = 'flex';
    }

    function openActionModal(mode) {
        actionModal.dataset.mode = mode;
        actionModalInput.classList.add('hidden');
        actionModalText.classList.add('hidden');
        
        switch(mode) {
            case 'add':
                actionModalTitle.textContent = "Добавить новый профиль";
                actionModalInput.classList.remove('hidden');
                actionModalInput.value = '';
                actionModalInput.placeholder = "Имя нового профиля";
                actionModalConfirm.textContent = "Добавить";
                break;
            case 'rename':
                actionModalTitle.textContent = "Переименовать профиль";
                actionModalInput.classList.remove('hidden');
                actionModalInput.value = allProfilesData[currentProfileKey].name;
                actionModalConfirm.textContent = "Переименовать";
                break;
            case 'delete':
                actionModalTitle.textContent = "Удалить профиль";
                actionModalText.classList.remove('hidden');
                actionModalText.textContent = `Вы уверены, что хотите удалить профиль "${allProfilesData[currentProfileKey].name}"?`;
                actionModalConfirm.textContent = "Удалить";
                break;
        }
        actionModal.style.display = 'flex';
    }

    function handleActionConfirm() {
        const mode = actionModal.dataset.mode;
        const inputValue = actionModalInput.value.trim();

        switch(mode) {
            case 'add':
                if (inputValue) {
                    const newKey = `profile_${Date.now()}`;
                    allProfilesData[newKey] = { name: inputValue, skills: [] };
                    currentProfileKey = newKey;
                } else { alert("Имя профиля не может быть пустым."); return; }
                break;
            case 'rename':
                if (inputValue && inputValue !== allProfilesData[currentProfileKey].name) {
                    allProfilesData[currentProfileKey].name = inputValue;
                } else { if (!inputValue) { alert("Имя профиля не может быть пустым."); return; } }
                break;
            case 'delete':
                delete allProfilesData[currentProfileKey];
                const keys = Object.keys(allProfilesData);
                currentProfileKey = keys.length > 0 ? keys[0] : null;
                break;
        }
        
        saveData();
        populateProfileSelector();
        renderAllProfiles();
        closeActionModal();
    }

    function closeSkillModal() { skillModal.style.display = 'none'; }
    function closeActionModal() { actionModal.style.display = 'none'; }

    // --- Обработчики событий ---
    profileSelector.addEventListener('change', (e) => switchToProfile(e.target.value));
    addProfileBtn.addEventListener('click', () => openActionModal('add'));
    renameProfileBtn.addEventListener('click', () => openActionModal('rename'));
    deleteProfileBtn.addEventListener('click', () => openActionModal('delete'));
    manageSkillsBtn.addEventListener('click', () => openSkillModal(-1));
    
    // События модальных окон
    skillModalValue.addEventListener('input', () => { skillModalOutput.textContent = skillModalValue.value; });
    skillModalSave.addEventListener('click', () => {
        const name = skillModalName.value.trim();
        const value = +skillModalValue.value;
        if (!name) { alert("Название навыка не может быть пустым."); return; }
        const currentSkills = allProfilesData[currentProfileKey].skills;
        if (editedSkillIndex === -1) { currentSkills.push({ name, value }); } 
        else { currentSkills[editedSkillIndex] = { name, value }; }
        saveData();
        renderAllProfiles();
        closeSkillModal();
    });
    skillModalDelete.addEventListener('click', () => {
        if (editedSkillIndex !== -1 && confirm("Удалить этот навык?")) {
            allProfilesData[currentProfileKey].skills.splice(editedSkillIndex, 1);
            saveData();
            renderAllProfiles();
            closeSkillModal();
        }
    });
    skillModalCancel.addEventListener('click', closeSkillModal);
    skillModalClose.addEventListener('click', closeSkillModal);
    actionModalConfirm.addEventListener('click', handleActionConfirm);
    actionModalCancel.addEventListener('click', closeActionModal);
    actionModalClose.addEventListener('click', closeActionModal);

    // --- Логика перетаскивания и свайпов ---
    function handleDragStart(clientX) {
        isDragging = true;
        touchStartX = clientX;
        startTranslate = currentTranslate;
        profileWrapper.style.transition = 'none';
        profileContainer.classList.add('grabbing');
    }

    function handleDragMove(clientX) {
        if (!isDragging) return;
        const diff = clientX - touchStartX;
        currentTranslate = startTranslate + diff;
        profileWrapper.style.transform = `translateX(${currentTranslate}px)`;
    }

    function handleDragEnd() {
        if (!isDragging) return;
        isDragging = false;
        profileContainer.classList.remove('grabbing');
        const diff = currentTranslate - startTranslate;
        const keys = Object.keys(allProfilesData);
        const currentIndex = keys.indexOf(currentProfileKey);
        
        if (Math.abs(diff) > 50) {
            if (diff < 0 && currentIndex < keys.length - 1) switchToProfile(keys[currentIndex + 1]);
            else if (diff > 0 && currentIndex > 0) switchToProfile(keys[currentIndex - 1]);
            else switchToProfile(currentProfileKey);
        } else {
            switchToProfile(currentProfileKey);
        }
        touchStartX = 0;
    }

    // Touch events
    profileContainer.addEventListener('touchstart', (e) => handleDragStart(e.touches[0].clientX));
    profileContainer.addEventListener('touchmove', (e) => handleDragMove(e.touches[0].clientX));
    profileContainer.addEventListener('touchend', handleDragEnd);
    // Mouse events
    profileContainer.addEventListener('mousedown', (e) => { e.preventDefault(); handleDragStart(e.clientX); });
    profileContainer.addEventListener('mousemove', (e) => handleDragMove(e.clientX));
    profileContainer.addEventListener('mouseup', handleDragEnd);
    profileContainer.addEventListener('mouseleave', () => { if(isDragging) handleDragEnd(); });


    // --- Инициализация ---
    loadData();
    populateProfileSelector();
    renderAllProfiles();
});
</script>
</body>
</html>