<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Неоновый радарный график с редактированием</title>
  <style>
    /* Общие стили */
    body {
      margin: 0;
      padding: 20px;
      background: #0a0a0a;
      color: #e0e0e0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center; /* Центрируем контент */
      touch-action: manipulation; /* Улучшаем работу сенсорного ввода */
    }
    #video-background {
        position: fixed;
        right: 0;
        bottom: 0;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        z-index: -1;
        object-fit: cover;
        filter: brightness(0.4);
    }
    h1 {
      text-align: center;
      color: #00e5ff;
      text-shadow: 0 0 8px #00e5ff;
      margin-bottom: 20px;
    }

    /* Контейнер для выбора радара и самого радара */
    .chart-section {
        width: 100%;
        max-width: 600px;
        margin: 0 auto 30px auto; /* Отступ снизу */
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative; /* Для позиционирования индикатора */
    }

    /* Контейнер для селектора и кнопки переименования */
    .profile-controls {
        display: flex;
        align-items: center;
        gap: 10px; /* Отступ между селектором и кнопкой */
        margin-bottom: 20px;
        width: 100%;
        max-width: 450px; /* Немного шире для кнопки */
        justify-content: center; /* Центрируем элементы */
    }

    /* Стили для селектора выбора радара */
    .chart-selector-container {
        flex-grow: 1; /* Селектор занимает доступное место */
        text-align: left; /* Лейбл слева */
    }
    .chart-selector-container label {
        display: block;
        margin-bottom: 8px;
        color: #00e5ff;
        font-weight: bold;
        text-shadow: 0 0 3px rgba(0, 229, 255, 0.5);
        text-align: center; /* Центрируем сам лейбл */
    }
    #chartSelector {
        width: 100%;
        box-sizing: border-box;
        background: #111;
        border: 1px solid #00e5ff;
        border-radius: 8px;
        padding: 10px 35px 10px 15px; /* Место для стрелки */
        color: #e0e0e0;
        font-size: 16px;
        cursor: pointer;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300e5ff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 12px auto;
        box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
    }
     #chartSelector:focus {
        outline: none;
        box-shadow: 0 0 15px rgba(0, 229, 255, 0.6);
    }

    /* Кнопка переименования профиля */
    #renameProfileBtn {
        padding: 10px 15px;
        background: #111;
        border: 1px solid #ffab00; /* Оранжевый */
        color: #ffab00;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        text-shadow: 0 0 4px #ffab00;
        box-shadow: 0 0 10px rgba(255, 171, 0, 0.3);
        transition: transform .2s, box-shadow .2s, background-color .2s, color .2s;
        white-space: nowrap; /* Чтобы текст не переносился */
    }
    #renameProfileBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 15px rgba(255, 171, 0, 0.6);
        background-color: #ffab00;
        color: #111;
    }

    #chart-container {
      width: 100%;
      background: #111;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 229, 255, 0.4);
      position: relative; /* Для позиционирования индикатора */
      transition: all 0.2s ease; /* Анимации смены и драга */
      will-change: transform, opacity; /* Оптимизация анимаций */
    }

     /* Контейнер для кнопок "Домой" и "Редактировать" */
    .main-actions-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px; /* Расстояние между кнопками */
        margin-bottom: 30px; /* Отступ снизу */
    }

    /* Кнопка Редактировать все */
    #editAllSkillsBtn {
      background: #111;
      border: 1px solid #00e5ff;
      color: #00e5ff;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      text-shadow: 0 0 4px #00e5ff;
      box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
      transition: transform .2s, box-shadow .2s;
      /* margin-bottom убран, управляется контейнером */
    }
    #editAllSkillsBtn:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 15px rgba(0, 229, 255, 0.6);
    }

    /* Кнопка/Ссылка "Домой" */
    #homeBtn {
      display: inline-flex; /* Для выравнивания иконки */
      align-items: center;
      justify-content: center;
      padding: 10px 12px; /* Чуть меньше по бокам для иконки */
      background: #111;
      border: 1px solid #00e5ff;
      color: #00e5ff; /* Цвет иконки */
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none; /* Убираем подчеркивание ссылки */
      box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
      transition: transform .2s, box-shadow .2s;
    }
    #homeBtn svg {
      width: 18px; /* Размер иконки */
      height: 18px;
      fill: currentColor; /* Иконка наследует цвет ссылки */
      vertical-align: middle; /* Выравнивание иконки */
    }
    #homeBtn:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 15px rgba(0, 229, 255, 0.6);
    }
    
    /* Индикатор профилей для мобильных */
    .profile-indicator {
        position: absolute;
        bottom: 10px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 8px;
        z-index: 10;
        pointer-events: none; /* Чтобы не мешал свайпам */
    }
    .profile-indicator-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: rgba(0, 229, 255, 0.4);
        transition: background-color 0.3s ease, transform 0.3s ease;
    }
    .profile-indicator-dot.active {
        background-color: #00e5ff;
        transform: scale(1.2);
    }

    /* Модальное окно */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none; /* Скрыто по умолчанию */
      align-items: center;
      justify-content: center;
      z-index: 1000; /* Поверх всего */
      animation: fadeIn 0.3s ease forwards;
      overflow-y: auto; /* Добавляем прокрутку если контент не влезает */
      padding: 20px 0; /* Отступы сверху/снизу для прокрутки */
    }
    .modal-content {
      position: relative;
      background: #111;
      padding: 25px;
      border-radius: 10px;
      width: 380px; /* Чуть шире для новых кнопок */
      max-width: 95%;
      box-shadow: 0 0 25px rgba(0,229,255,0.5);
      transform: scale(0.8);
      opacity: 0;
      animation: popIn 0.3s ease forwards 0.1s;
      border: 1px solid rgba(0, 229, 255, 0.5);
      margin: auto; /* Центрирование при прокрутке */
    }
    .modal-content h2 {
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
      color: #00e5ff;
      text-shadow: 0 0 5px #00e5ff;
      font-size: 20px;
    }
    .modal-content label {
      display: block;
      margin: 12px 0 5px;
      color: #00e5ff;
      font-weight: bold;
      font-size: 14px;
      text-shadow: 0 0 3px rgba(0, 229, 255, 0.5);
    }
    /* Стили для инпутов, селекта и ползунка в модалке */
    .modal-content input[type="text"],
    .modal-content input[type="range"],
    .modal-content select {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 10px;
      background: #0a0a0a;
      border: 1px solid #00e5ff;
      border-radius: 5px;
      padding: 8px 12px;
      color: #e0e0e0;
      font-size: 15px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
    }
     .modal-content select { /* Стили для селекта навыков */
         appearance: none;
         padding-right: 30px; /* Место для стрелки */
         background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300e5ff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
         background-repeat: no-repeat;
         background-position: right 10px center;
         background-size: 10px auto;
     }
    .modal-content input[type="range"] {
      padding: 0;
      height: 8px;
      cursor: pointer;
      -webkit-appearance: none;
      outline: none;
    }
    .modal-content input[type="range"]::-webkit-slider-runnable-track {
      background: #222;
      border-radius: 4px;
      height: 100%;
    }
    .modal-content input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: #00e5ff;
      border-radius: 50%;
      box-shadow: 0 0 8px #00e5ff;
      margin-top: -5px;
    }
     .modal-content input[type="range"]::-moz-range-track {
        background: #222;
        border-radius: 4px;
        height: 8px;
        border: none;
    }
    .modal-content input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: #00e5ff;
        border-radius: 50%;
        box-shadow: 0 0 8px #00e5ff;
        border: none;
        cursor: pointer;
    }
    .modal-content output {
        display: block;
        text-align: center;
        font-size: 16px;
        font-weight: bold;
        color: #00e5ff;
        margin-bottom: 15px;
        text-shadow: 0 0 4px #00e5ff;
    }
    /* Блок с кнопками действий над навыком (основной, удалить) */
    .skill-action-buttons {
        display: flex;
        gap: 10px; /* Отступ между кнопками */
        margin-top: 5px; /* Небольшой отступ сверху */
        margin-bottom: 15px; /* Отступ снизу */
    }
    #setMainSkillBtn, #removeSkillBtn {
        flex: 1; /* Занимают равное место */
        padding: 8px 10px; /* Чуть меньше паддинг */
        font-size: 13px; /* Чуть меньше шрифт */
    }
    /* Стили для кнопки удаления */
    #removeSkillBtn {
        background: #111;
        border: 1px solid #ff4d4d; /* Красный */
        color: #ff4d4d;
        text-shadow: 0 0 4px #ff4d4d;
        box-shadow: 0 0 10px rgba(255, 77, 77, 0.3);
    }
    #removeSkillBtn:hover {
        background-color: #ff4d4d;
        color: #111;
        box-shadow: 0 0 15px rgba(255, 77, 77, 0.6);
        transform: scale(1.03);
    }
     #removeSkillBtn:disabled {
         border-color: #555;
         color: #555;
         cursor: not-allowed;
         text-shadow: none;
         box-shadow: none;
         opacity: 0.6;
     }

    /* Кнопки навигации, сохранения и добавления */
    .modal-bottom-actions {
        display: flex;
        flex-direction: column; /* Кнопки друг под другом */
        gap: 10px;
    }
    .modal-nav-buttons {
      display: flex;
      justify-content: space-between;
      order: 1; /* Навигация */
      gap: 10px; /* Отступ между кнопками */
    }
     .modal-nav-buttons button {
        flex-grow: 1;
     }

    #addSkillBtn {
        order: 2; /* Кнопка добавления */
        background: #111;
        border: 1px solid #56ff56; /* Зеленый */
        color: #56ff56;
        text-shadow: 0 0 4px #56ff56;
        box-shadow: 0 0 10px rgba(86, 255, 86, 0.3);
    }
     #addSkillBtn:hover {
        background-color: #56ff56;
        color: #111;
        box-shadow: 0 0 15px rgba(86, 255, 86, 0.6);
     }

    #modalSave {
        width: 100%;
        order: 3; /* Кнопка сохранить последняя */
        background-color: #00c4cc;
    }

    /* Общие стили для всех кнопок в модалке (кроме Close) */
    .modal-nav-buttons button, #setMainSkillBtn, #removeSkillBtn, #addSkillBtn, #modalSave {
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.2s ease; /* Общий transition */
        border: none;
        color: #111;
        background-color: #00e5ff; /* Синий по умолчанию */
    }
     /* Стили для кнопок с рамкой */
    #setMainSkillBtn, #removeSkillBtn, #addSkillBtn {
         color: #e0e0e0; /* Цвет текста для кнопок с рамкой по умолчанию */
     }
     /* Стили ховера для кнопок (кроме тех, что уже переопределены) */
    .modal-nav-buttons button:not(:disabled):hover,
    #modalSave:hover {
        filter: brightness(1.1);
        transform: scale(1.03);
        box-shadow: 0 0 15px rgba(0, 229, 255, 0.6);
    }
    /* Стили ховера для кнопки "Основной" */
    #setMainSkillBtn:not(:disabled):hover {
        background-color: #ffab00;
        color: #111;
        box-shadow: 0 0 15px rgba(255, 171, 0, 0.6);
        transform: scale(1.03);
    }
    /* Отключение кнопки "Основной" */
     #setMainSkillBtn:disabled {
         border-color: #555;
         color: #555;
         cursor: not-allowed;
         text-shadow: none;
         box-shadow: none;
         opacity: 0.6;
         background-color: #111; /* Убедимся, что фон темный */
     }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 24px;
      color: #aaa;
      transition: color 0.2s, transform 0.2s;
      line-height: 1;
    }
    .modal-close:hover {
      color: #fff;
      transform: rotate(90deg);
    }

    /* Анимации */
    @keyframes fadeIn {
      from { background: rgba(0,0,0,0); }
      to { background: rgba(0,0,0,0.7); }
    }
    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    /* Мобильные стили */
    @media (max-width: 600px) {
        .profile-controls {
            flex-direction: column;
            gap: 15px;
        }
        #chart-container {
            padding: 15px;
        }
        .main-actions-container {
            flex-direction: column;
            gap: 10px;
        }
        #homeBtn, #editAllSkillsBtn {
            width: 100%;
            max-width: 300px;
        }
    }

    /* Стиль курсора для кликабельных точек радара */
    #radarChart {
      cursor: pointer;
    }
  </style>
  <script src="sounds.js" defer></script>
</head>
<body>
  <video autoplay loop muted playsinline id="video-background" style="display: none;">
      <source src="background.mp4" type="video/mp4">
  </video>

  <h1>Неоновый радар</h1>

  <div class="chart-section">
      <!-- Управление профилем -->
      <div class="profile-controls">
          <div class="chart-selector-container">
              <label for="chartSelector">Выберите профиль</label>
              <select id="chartSelector"></select>
          </div>
          <button id="renameProfileBtn" title="Переименовать текущий профиль" class="clickable-sound">Переименовать</button>
      </div>

      <!-- Контейнер для графика -->
      <div id="chart-container">
          <canvas id="radarChart"></canvas>
          <!-- Индикатор профилей -->
          <div class="profile-indicator" id="profileIndicator"></div>
      </div>
  </div>

  <!-- Контейнер для кнопок действий -->
  <div class="main-actions-container">
       <a href="index.html" id="homeBtn" title="На главную" class="clickable-sound">
           <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L8.354 1.146zM12 14H9.5v-4.5a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5V14H4V7.707l4-4 4 4V14z"/>
              <path d="M6.5 14.5v-3.505c0-.245.25-.495.5-.495h2c.25 0 .5.25.5.5v3.505a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5V7.207l-6-6.094-6 6.094V14a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5z"/>
           </svg>
       </a>
       <button id="editAllSkillsBtn" class="clickable-sound">Редактировать навыки</button>
   </div>


  <!-- Модальное окно для редактирования -->
  <div class="modal-overlay" id="modal">
    <div class="modal-content">
      <button class="modal-close clickable-sound" id="modalClose" title="Закрыть">×</button>
      <h2 id="modalTitle">Редактировать навык</h2> <!-- Динамический заголовок -->

      <label for="skillSelect">Выбор навыка</label>
      <select id="skillSelect"></select>

      <label for="modalLabel">Название навыка</label>
      <input type="text" id="modalLabel" placeholder="Введите новое название" />

      <label for="modalLevel">Уровень навыка</label>
      <input type="range" id="modalLevel" min="0" max="100" />
      <output id="modalOutput"></output> <!-- Вывод значения под ползунком -->

       <!-- Кнопки действий над навыком -->
      <div class="skill-action-buttons">
           <button id="setMainSkillBtn" class="clickable-sound">Сделать основным</button>
           <button id="removeSkillBtn" title="Удалить текущий навык" class="clickable-sound">Удалить этот навык</button>
      </div>

      <!-- Нижний блок кнопок -->
      <div class="modal-bottom-actions">
          <div class="modal-nav-buttons">
            <button id="prevBtn" class="clickable-sound">← Пред.</button>
            <button id="nextBtn" class="clickable-sound">След. →</button>
          </div>
          <button id="addSkillBtn" title="Добавить новый навык в этот профиль" class="clickable-sound">Добавить навык</button>
          <button id="modalSave" class="clickable-sound">Сохранить изменения</button>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Apply video setting
      const videoBackground = document.getElementById('video-background');
      if (videoBackground) {
          const SETTINGS_KEY = 'app_settings';
          const savedSettings = localStorage.getItem(SETTINGS_KEY);
          let showVideo = true; // Default to true
          if (savedSettings) {
              try {
                  const settings = JSON.parse(savedSettings);
                  if (settings.showVideoBackground === false) {
                      showVideo = false;
                  }
              } catch (e) { console.error("Could not parse settings, using default for video.", e); }
          }
          videoBackground.style.display = showVideo ? 'block' : 'none';
      }

      // Original script content starts here
    });

    document.addEventListener('DOMContentLoaded', () => {
      // --- DOM Элементы ---
      const ctx = document.getElementById('radarChart').getContext('2d');
      const chartSelector = document.getElementById('chartSelector');
      const renameProfileBtn = document.getElementById('renameProfileBtn');
      const editAllSkillsBtn = document.getElementById('editAllSkillsBtn');
      const profileIndicator = document.getElementById('profileIndicator');
      // Модалка
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modalTitle');
      const skillSelect = document.getElementById('skillSelect');
      const modalLabel = document.getElementById('modalLabel');
      const modalLevel = document.getElementById('modalLevel');
      const modalOutput = document.getElementById('modalOutput');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const saveBtn = document.getElementById('modalSave');
      const closeBtn = document.getElementById('modalClose');
      const setMainSkillBtn = document.getElementById('setMainSkillBtn');
      const removeSkillBtn = document.getElementById('removeSkillBtn');
      const addSkillBtn = document.getElementById('addSkillBtn');
      const chartContainer = document.getElementById('chart-container');

      // --- Константы и переменные ---
      const MIN_SKILLS = 3;
      const LOCAL_STORAGE_KEY = 'radarChartData_v2';
      // Цвета
      const neonBlue = '#00e5ff';
      const neonBlueFill = 'rgba(0,229,255,0.2)';
      const neonBlueBorder = 'rgba(0,229,255,1)';
      const neonRed = '#ff4d4d';
      const neonRedFill = 'rgba(255, 77, 77, 0.3)';
      const neonRedBorder = 'rgba(255, 77, 77, 1)';
      const whiteColor = '#ffffff';
      const mainSkillBorderColor = whiteColor;
      const defaultPointBorderColor = whiteColor;
      
      // Для свайпов и тапов
      let touchStartX = 0;
      let lastTapTime = 0;
      const SWIPE_THRESHOLD = 50; // Порог для свайпа
      const DOUBLE_TAP_DELAY = 300; // Максимальное время между тапами в мс

      // --- Данные ---
      let allChartData = loadDataFromLocalStorage();
      if (!allChartData || Object.keys(allChartData).length === 0) {
          allChartData = { // Данные по умолчанию
              'profile1': { name: "Профиль 1: Развитие", skills: [ { label: 'Money', value: 80, isMain: false }, { label: 'Business', value: 70, isMain: false }, { label: 'Fitness', value: 60, isMain: false }, { label: 'Entrepreneur', value: 90, isMain: true }, { label: 'Mindset', value: 85, isMain: false }, { label: 'Love', value: 40, isMain: false } ] },
              'profile2': { name: "Профиль 2: Баланс", skills: [ { label: 'Работа', value: 60, isMain: true }, { label: 'Семья', value: 75, isMain: false }, { label: 'Хобби', value: 50, isMain: false }, { label: 'Здоровье', value: 90, isMain: false }, { label: 'Друзья', value: 65, isMain: false }, { label: 'Саморазвитие', value: 80, isMain: false } ] }
          };
          saveDataToLocalStorage();
      }

      let currentChartKey = Object.keys(allChartData)[0];
      let activeSkillData = [];
      let activeIndex = 0;
      let chart;

      // --- Функции ---

      // Сохранение и загрузка данных
      function saveDataToLocalStorage() {
          try {
              localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allChartData));
          } catch (e) { console.error("Ошибка сохранения данных:", e); }
      }
      function loadDataFromLocalStorage() {
          try {
              const data = localStorage.getItem(LOCAL_STORAGE_KEY);
              return data ? JSON.parse(data) : null;
          } catch (e) { console.error("Ошибка загрузки данных:", e); return null; }
      }

      // Заполнение селектора профилей
      function populateChartSelector() {
          const keys = Object.keys(allChartData);
          chartSelector.innerHTML = '';
          if (keys.length === 0) {
              renameProfileBtn.disabled = true;
              editAllSkillsBtn.disabled = true;
               chartSelector.disabled = true;
              return;
          }
          renameProfileBtn.disabled = false;
          editAllSkillsBtn.disabled = false;
           chartSelector.disabled = false;

          keys.forEach(key => {
              const option = document.createElement('option');
              option.value = key;
              option.textContent = allChartData[key].name;
              chartSelector.appendChild(option);
          });
          if (!allChartData[currentChartKey]) {
              currentChartKey = keys[0];
          }
          chartSelector.value = currentChartKey;
          updateProfileIndicator();
      }

      // Обновление индикатора профилей
      function updateProfileIndicator() {
          profileIndicator.innerHTML = '';
          const keys = Object.keys(allChartData);
          const currentIndex = keys.indexOf(currentChartKey);
          
          keys.forEach((_, i) => {
              const dot = document.createElement('div');
              dot.className = 'profile-indicator-dot';
              if (i === currentIndex) {
                  dot.classList.add('active');
              }
              profileIndicator.appendChild(dot);
          });
      }

      // Загрузка данных выбранного профиля
      function loadChartData(key) {
          if (!allChartData || !allChartData[key]) {
              console.error(`Профиль с ключом "${key}" не найден.`);
              if(chart) chart.destroy(); chart = null;
               const canvasCtx = ctx;
               canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);
               canvasCtx.save();
               canvasCtx.textAlign = 'center'; canvasCtx.textBaseline = 'middle';
               canvasCtx.fillStyle = '#888'; canvasCtx.font = '16px Segoe UI';
               canvasCtx.fillText('Ошибка загрузки профиля', canvasCtx.canvas.width / 2, canvasCtx.canvas.height / 2);
               canvasCtx.restore();
              return;
          }
          currentChartKey = key;
          activeSkillData = allChartData[key].skills;
          const mainIndex = activeSkillData.findIndex(skill => skill.isMain);
          activeIndex = mainIndex !== -1 ? mainIndex : (activeSkillData.length > 0 ? 0 : -1);
          updateChart();
          populateSkillSelect();
          updateProfileIndicator();
          if (chartSelector.value !== key) {
              chartSelector.value = key;
          }
      }

      // Заполнение селектора НАВЫКОВ в модалке
      function populateSkillSelect() {
          skillSelect.innerHTML = '';
          if (!activeSkillData || activeSkillData.length === 0) return;
          activeSkillData.forEach((item, i) => {
              const opt = document.createElement('option');
              opt.value = i;
              opt.textContent = item.label + (item.isMain ? ' (Основной)' : '');
              skillSelect.appendChild(opt);
          });
          if (activeIndex >= 0 && activeIndex < activeSkillData.length) {
             skillSelect.value = activeIndex;
          } else if (activeSkillData.length > 0) {
             activeIndex = 0;
             skillSelect.value = activeIndex;
          }
      }

      // Обновление контента модального окна
      function updateModalContent(index) {
        const hasSkills = activeSkillData && activeSkillData.length > 0;
        const isValidIndex = hasSkills && index >= 0 && index < activeSkillData.length;

        skillSelect.disabled = !hasSkills;
        modalLabel.disabled = !isValidIndex;
        modalLevel.disabled = !isValidIndex;
        setMainSkillBtn.disabled = !isValidIndex || activeSkillData[index].isMain;
        removeSkillBtn.disabled = !isValidIndex || activeSkillData.length <= MIN_SKILLS;
        prevBtn.disabled = !hasSkills;
        nextBtn.disabled = !hasSkills;
        saveBtn.disabled = !isValidIndex;

        if (!isValidIndex) {
             modalLabel.value = '';
             modalLevel.value = 0;
             modalOutput.textContent = '0';
             setMainSkillBtn.textContent = 'Сделать основным';
             removeSkillBtn.title = `Нельзя удалить, минимум ${MIN_SKILLS} навыка`;
        } else {
            activeIndex = index;
            const currentSkill = activeSkillData[index];
            modalLabel.value = currentSkill.label;
            modalLevel.value = currentSkill.value;
            modalOutput.textContent = currentSkill.value;
            setMainSkillBtn.textContent = currentSkill.isMain ? '✓ Основной' : 'Сделать основным';
            removeSkillBtn.title = removeSkillBtn.disabled
                ? `Нельзя удалить, минимум ${MIN_SKILLS} навыка`
                : `Удалить навык "${currentSkill.label}"`;
        }
        populateSkillSelect();
      }

      // Обновление / создание графика
      function updateChart() {
          if (!activeSkillData || activeSkillData.length < MIN_SKILLS) {
              if (chart) chart.destroy(); chart = null;
              const canvasCtx = ctx;
              canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);
              canvasCtx.save();
              canvasCtx.textAlign = 'center'; canvasCtx.textBaseline = 'middle';
              canvasCtx.fillStyle = '#888'; canvasCtx.font = '16px Segoe UI';
              canvasCtx.fillText(
                  !activeSkillData || activeSkillData.length === 0
                      ? 'Нет навыков в профиле. Добавьте их.'
                      : `Нужно минимум ${MIN_SKILLS} навыка для радара`,
                  canvasCtx.canvas.width / 2, canvasCtx.canvas.height / 2
              );
              canvasCtx.restore();
              return;
          }

          const labels = activeSkillData.map(item => item.label);
          const dataValues = activeSkillData.map(item => item.value);
          const allMaxed = activeSkillData.every(skill => skill.value === 100);

          const pointBackgroundColors = activeSkillData.map(item => item.isMain ? neonBlue : (item.value === 100 ? neonRed : neonBlue));
          const pointBorderColors = activeSkillData.map(item => item.isMain ? mainSkillBorderColor : (item.value === 100 ? neonRed : defaultPointBorderColor));
          const pointRadii = activeSkillData.map(item => item.isMain ? 8 : 5);
          const pointHoverRadii = activeSkillData.map(item => item.isMain ? 10 : 7);
          const pointBorderWidths = activeSkillData.map(item => item.isMain ? 2 : 1);

          const dataset = {
              data: dataValues, fill: true,
              backgroundColor: allMaxed ? neonRedFill : neonBlueFill,
              borderColor: allMaxed ? neonRedBorder : neonBlueBorder,
              pointBackgroundColor: pointBackgroundColors, pointBorderColor: pointBorderColors,
              pointHoverBackgroundColor: whiteColor,
              pointHoverBorderColor: pointBorderColors.map(color => color === neonRed ? neonRed : neonBlue),
              pointRadius: pointRadii, pointHoverRadius: pointHoverRadii,
              borderWidth: 2, pointBorderWidth: pointBorderWidths,
          };

          const chartOptions = {
                responsive: true, maintainAspectRatio: true,
                scales: {
                    r: {
                        min: 0, max: 100,
                        ticks: { stepSize: 20, color: '#bbb', backdropColor: 'rgba(0,0,0,0.5)', font: { size: 10 } },
                        grid: { color: allMaxed ? 'rgba(255, 77, 77, 0.2)' : 'rgba(0, 229, 255, 0.2)' },
                        angleLines: { color: allMaxed ? 'rgba(255, 77, 77, 0.2)' : 'rgba(0, 229, 255, 0.2)' },
                        pointLabels: {
                            color: '#00e5ff', font: { size: 14, weight: 'bold' },
                            backdropColor: '#111', backdropPadding: 3, borderRadius: 4,
                            callback: (label, index) => (activeSkillData[index]?.isMain ? `★ ${label} ★` : label)
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true, backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#00e5ff', bodyColor: '#e0e0e0', padding: 10, cornerRadius: 4,
                        callbacks: {
                            label: function(context) {
                                const skill = activeSkillData[context.dataIndex];
                                if (!skill) return '';
                                let label = `${skill.label}: ${context.formattedValue}`;
                                if (skill.isMain) label += ' (Основной)';
                                return label;
                            }
                        }
                    }
                }
            };

          if (chart) {
              chart.data.labels = labels;
              chart.data.datasets[0] = dataset;
              chart.options = chartOptions;
              chart.update();
          } else {
              chart = new Chart(ctx, { type: 'radar', data: { labels: labels, datasets: [dataset] }, options: chartOptions });
          }
      }

      // --- Обработчики событий ---

      chartSelector.addEventListener('change', (event) => loadChartData(event.target.value));

      renameProfileBtn.addEventListener('click', () => {
          if (!currentChartKey || !allChartData[currentChartKey]) return;
          const currentName = allChartData[currentChartKey].name;
          const newName = prompt(`Введите новое имя для профиля "${currentName}":`, currentName);
          if (newName && newName.trim() && newName !== currentName) {
              allChartData[currentChartKey].name = newName.trim();
              populateChartSelector();
              if (modal.style.display === 'flex') {
                  modalTitle.textContent = `Редактирование: ${allChartData[currentChartKey].name}`;
              }
              saveDataToLocalStorage();
          }
      });

      editAllSkillsBtn.addEventListener('click', () => {
          if (!currentChartKey || !allChartData[currentChartKey]) {
              alert("Сначала выберите или создайте профиль.");
              return;
          }
          modalTitle.textContent = `Редактирование: ${allChartData[currentChartKey].name}`;
          populateSkillSelect();
          updateModalContent(activeIndex);
          modal.style.display = 'flex';
      });

      closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });
      modal.addEventListener('click', (event) => { if (event.target === modal) modal.style.display = 'none'; });

      skillSelect.addEventListener('change', () => {
          updateModalContent(+skillSelect.value);
      });

      prevBtn.addEventListener('click', () => {
          if (!activeSkillData || activeSkillData.length === 0) return;
          const newIndex = (activeIndex - 1 + activeSkillData.length) % activeSkillData.length;
          updateModalContent(newIndex);
      });
      nextBtn.addEventListener('click', () => {
          if (!activeSkillData || activeSkillData.length === 0) return;
          const newIndex = (activeIndex + 1) % activeSkillData.length;
          updateModalContent(newIndex);
      });

      modalLevel.addEventListener('input', () => { modalOutput.textContent = modalLevel.value; });

      setMainSkillBtn.addEventListener('click', () => {
          if (!activeSkillData || !activeSkillData[activeIndex] || activeSkillData[activeIndex].isMain) return;
          activeSkillData.forEach(skill => skill.isMain = false);
          activeSkillData[activeIndex].isMain = true;
          updateModalContent(activeIndex);
          updateChart();
          saveDataToLocalStorage();
      });

      removeSkillBtn.addEventListener('click', () => {
          if (!activeSkillData || !activeSkillData[activeIndex] || removeSkillBtn.disabled) return;
          const skillToRemove = activeSkillData[activeIndex];
          if (confirm(`Вы уверены, что хотите удалить навык "${skillToRemove.label}"?`)) {
              activeSkillData.splice(activeIndex, 1);
              if (activeIndex >= activeSkillData.length) {
                  activeIndex = Math.max(0, activeSkillData.length - 1);
              }
              updateChart();
              updateModalContent(activeIndex);
              saveDataToLocalStorage();
          }
      });

      addSkillBtn.addEventListener('click', () => {
          if (!currentChartKey || !allChartData[currentChartKey]) return;
          const newLabel = prompt("Введите название нового навыка:", "Новый навык");
          if (!newLabel || !newLabel.trim()) return;
          let newValueStr = prompt(`Введите начальный уровень для "${newLabel}" (0-100):`, "0");
          let newValue = parseInt(newValueStr, 10);
          newValue = isNaN(newValue) ? 0 : Math.max(0, Math.min(100, newValue));
          const newSkill = { label: newLabel.trim(), value: newValue, isMain: false };
          activeSkillData.push(newSkill);
          activeIndex = activeSkillData.length - 1;
          updateChart();
          updateModalContent(activeIndex);
          saveDataToLocalStorage();
      });

      saveBtn.addEventListener('click', () => {
          if (saveBtn.disabled || !activeSkillData || !activeSkillData[activeIndex]) return;
          const currentSkill = activeSkillData[activeIndex];
          const newLabel = modalLabel.value.trim();
          const newValue = +modalLevel.value;
          let changed = false;
          if (newLabel && newLabel !== currentSkill.label) {
              currentSkill.label = newLabel; changed = true;
          }
          if (newValue !== currentSkill.value) {
              currentSkill.value = newValue; changed = true;
          }
          if (changed) {
              updateChart();
              populateSkillSelect();
              skillSelect.value = activeIndex;
              saveDataToLocalStorage();
          }
          modal.style.display = 'none';
      });

      // --- ОБНОВЛЕННЫЙ БЛОК: Обработчики свайпов и кликов ---
      function setupSwipeAndTap() {
        let touchMoveDiff = 0;

        // Для мобильных устройств
        chartContainer.addEventListener('touchstart', function(e) {
          if (modal.style.display === 'flex') return;
          
          const now = Date.now();
          const touch = e.changedTouches[0];
          
          // Обработка двойного тапа
          if (now - lastTapTime < DOUBLE_TAP_DELAY) {
            e.preventDefault(); // Предотвратить зум
            const rect = e.target.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            handleChartClick(x, y);
            // Сбрасываем таймер, чтобы избежать тройного тапа
            lastTapTime = 0; 
            return; // Завершаем обработку
          }
          
          lastTapTime = now;
          touchStartX = touch.clientX;
          touchMoveDiff = 0; // Сбрасываем сдвиг при новом касании
        }, { passive: false });

        chartContainer.addEventListener('touchmove', function(e) {
          if (modal.style.display === 'flex' || e.touches.length > 1) return;
          
          touchMoveDiff = e.changedTouches[0].clientX - touchStartX;
          // Визуальная индикация свайпа
          chartContainer.style.transform = `translateX(${touchMoveDiff * 0.5}px)`;
          chartContainer.style.opacity = `${1 - Math.min(0.5, Math.abs(touchMoveDiff / 300))}`;
          
        }, { passive: true });

        chartContainer.addEventListener('touchend', function(e) {
          if (modal.style.display === 'flex') return;
          
          chartContainer.style.transform = '';
          chartContainer.style.opacity = '';
          
          if (Math.abs(touchMoveDiff) > SWIPE_THRESHOLD) {
              if (touchMoveDiff > 0) switchToPrevProfile();
              else switchToNextProfile();
          }
          touchMoveDiff = 0;
        });

        // Для ПК - двойной клик
        document.getElementById('radarChart').addEventListener('dblclick', function(e) {
          if (modal.style.display === 'flex') return;
          const rect = this.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          handleChartClick(x, y);
        });
      }

      function handleChartClick(x, y) {
        if (!chart || !activeSkillData || activeSkillData.length === 0) return;
        
        const activeElements = chart.getElementsAtEventForMode(
          {x: x, y: y}, 
          'nearest', 
          {intersect: true}, 
          true
        );
        
        if (activeElements && activeElements.length > 0) {
          const skillIndex = activeElements[0].index;
          
          // Открываем модалку для редактирования выбранного навыка
          modalTitle.textContent = `Редактирование: ${allChartData[currentChartKey].name}`;
          updateModalContent(skillIndex);
          modal.style.display = 'flex';
        }
      }

      // --- Функции для переключения радаров ---
      function switchToNextProfile() {
          const keys = Object.keys(allChartData);
          if (keys.length <= 1) return;
          const currentIndex = keys.indexOf(currentChartKey);
          const newIndex = (currentIndex + 1) % keys.length;
          animateSwitch(keys[newIndex]);
      }

      function switchToPrevProfile() {
          const keys = Object.keys(allChartData);
          if (keys.length <= 1) return;
          const currentIndex = keys.indexOf(currentChartKey);
          const newIndex = (currentIndex - 1 + keys.length) % keys.length;
          animateSwitch(keys[newIndex]);
      }

      function animateSwitch(newKey) {
          chartContainer.style.opacity = '0.3';
          setTimeout(() => {
              loadChartData(newKey);
              chartContainer.style.opacity = '1';
          }, 200);
      }

      // --- Обработчики событий для перетаскивания мышью ---
      let isDragging = false;
      let dragStartX = 0;
      
      chartContainer.addEventListener('mousedown', (e) => {
          if (modal.style.display === 'flex' || e.button !== 0) return;
          isDragging = true;
          dragStartX = e.clientX;
      });

      document.addEventListener('mousemove', (e) => {
          if (!isDragging || modal.style.display === 'flex') return;
          const diff = e.clientX - dragStartX;
          chartContainer.style.transform = `translateX(${diff * 0.5}px)`;
          chartContainer.style.opacity = `${1 - Math.min(0.5, Math.abs(diff / 300))}`;
      });

      document.addEventListener('mouseup', (e) => {
          if (!isDragging) return;
          isDragging = false;
          const diff = e.clientX - dragStartX;
          
          chartContainer.style.transform = '';
          chartContainer.style.opacity = '';
          
          if (Math.abs(diff) > 100) { // Порог для перетаскивания
              if (diff > 0) switchToPrevProfile();
              else switchToNextProfile();
          }
      });

      // --- Первичная инициализация ---
      populateChartSelector();
      loadChartData(currentChartKey);
      setupSwipeAndTap(); // Инициализация обработчиков свайпов и кликов

    });
  </script>
</body>
</html>